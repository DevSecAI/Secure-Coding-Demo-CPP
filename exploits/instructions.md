# Exploitation Instructions

**Functional Thinking Bank Demo - Vulnerability Exploitation Guide**

*Author: Abiola-DevSecAI*

## Important Notice

**This guide is for educational purposes only.** Use these techniques solely on the provided demonstration application. Unauthorised exploitation of systems is illegal and unethical.

## Overview

This guide provides detailed technical instructions for exploiting the two vulnerabilities demonstrated in the Functional Thinking Bank:

1. **Buffer Overflow** - Memory corruption via unchecked string copying
2. **Integer Overflow** - Logic bypass via unchecked numeric conversion

## Prerequisites

- Functional thinking bank application running (`make run`)
- Web browser for exploitation tools
- Basic understanding of memory layout and integer arithmetic

## Target Analysis

### Application Architecture
- **Frontend**: HTML forms with POST requests
- **Backend**: C++ application with embedded HTTP server
- **Port**: 8080 (localhost)
- **Endpoints**: `/update-profile`, `/transfer`

### Memory Layout (Vulnerable Version)
```cpp
struct Customer {
    char account_number[20];  // Offset 0-19
    char full_name[32];       // Offset 20-51   ‚Üê Buffer overflow target
    char address[64];         // Offset 52-115  ‚Üê Buffer overflow target  
    long long balance_pence;  // Offset 116-123
    char phone[16];           // Offset 124-139
};
```

## Vulnerability 1: Buffer Overflow Exploitation

### Technical Background

**Vulnerable Function:** `handleProfileUpdate()` in `src/vulnerable_bank.cpp`

**Root Cause:**
```cpp
// Lines that create the vulnerability
strcpy(customer.full_name, new_name.c_str());    // No bounds checking
strcpy(customer.address, new_address.c_str());   // No bounds checking
```

**Why It's Vulnerable:**
- `strcpy()` copies until null terminator without size validation
- Buffer sizes: `full_name[32]`, `address[64]`
- Adjacent memory can be overwritten

### Exploitation Steps

#### Step 1: Environment Setup
```bash
# Terminal 1: Start vulnerable application
cd vulnerable-bank-demo
make run

# Terminal 2: Verify application is running
curl http://localhost:8080  # Should return HTML
```

#### Step 2: Basic Overflow Test

**Target:** Name buffer (32 bytes)

1. **Open the banking application:** http://localhost:8080
2. **Navigate to:** "Update Customer Profile"
3. **Select account:** ACC001 (James Smith)
4. **Input malicious payload:**
   - **Name:** `AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA_OVERFLOW_MARKER`
   - **Address:** `Normal address`

**Payload Analysis:**
- Length: 32 A's + 16 additional characters = 48 total
- Overflow: 16 bytes beyond buffer boundary
- Impact: Overwrites start of address buffer

#### Step 3: Large Overflow Attack

**Target:** Both buffers simultaneously

1. **Use the exploitation tool:**
   ```bash
   open exploits/buffer_overflow_attack.html
   ```

2. **Generate payload:**
   - Select: "Both Buffers - Simultaneous Overflow"
   - Copy both generated payloads

3. **Execute attack:**
   - Paste name payload into name field
   - Paste address payload into address field
   - Submit form

**Expected Results:**
- Application crash (segmentation fault)
- Memory corruption
- Potential code execution (in real scenarios)

#### Step 4: Advanced Exploitation Techniques

**Payload Crafting for Maximum Impact:**

```
Name Buffer Attack (100 characters):
AAAA[repeated 25 times]_CONTROLLED_OVERFLOW_BBBB[repeated 5 times]

Address Buffer Attack (200 characters):  
CCCC[repeated 50 times]_LARGE_ADDRESS_OVERFLOW_DDDD[repeated 20 times]
```

**Memory Corruption Analysis:**
- Name overflow corrupts address buffer start
- Address overflow corrupts balance_pence field  
- Large overflows may corrupt heap metadata
- Stack-based overflows could overwrite return addresses

### Technical Deep Dive: What Happens During Overflow

1. **Normal Operation:**
   ```
   Memory Layout:
   [account_number][full_name_____][address________][balance][phone]
   ```

2. **Buffer Overflow:**
   ```
   Memory Layout:
   [account_number][AAAA_OVERFLOW_MARKER_CONTINUES_INTO_ADDRESS_SPACE]
   ```

3. **Corruption Results:**
   - Adjacent fields overwritten with attacker data
   - Null terminator may be missing
   - Heap corruption possible with large payloads

## üí∞ Vulnerability 2: Integer Overflow Exploitation

### Technical Background

**Vulnerable Function:** `handleTransfer()` in `src/vulnerable_bank.cpp`

**Root Cause:**
```cpp
// Lines that create the vulnerability
long long amount_pence = std::stoll(amount_str) * 100;  // No validation

// Flawed validation logic
if (amount_pence > 0 && from_customer.balance_pence >= amount_pence) {
    // Process transfer...
}
```

**Why It's Vulnerable:**
- No input validation before conversion
- Assumes positive amounts only
- Integer overflow not detected
- Arithmetic can wrap around

### Exploitation Scenarios

#### Scenario 1: Negative Number Attack

**Objective:** Steal money using negative transfers

**Technical Mechanism:**
1. Input: `-1000` (negative ¬£1,000)
2. Conversion: `std::stoll("-1000") = -1000`
3. Multiplication: `-1000 * 100 = -100000 pence`
4. Validation: `-100000 > 0` ‚Üí **FALSE**
5. **But:** Logic flaw allows negative amounts to pass

**Step-by-Step Exploitation:**

1. **Open integer overflow tool:**
   ```bash
   open exploits/integer_overflow_attack.html
   ```

2. **Configure attack:**
   - Attack type: "Negative Transfer - Large Amount (-¬£10,000)"
   - Copy generated payload: `-10000`

3. **Execute on banking app:**
   - From Account: ACC002 (Sarah - ¬£750.00)
   - To Account: ACC001 (James - ¬£2,500.00)
   - Amount: `-10000`

4. **Result Analysis:**
   - Sarah's balance: ¬£750 - (-¬£10,000) = ¬£10,750 (money created!)
   - James's balance: ¬£2,500 + (-¬£10,000) = -¬£7,500 (debt created!)
   - **Total impact:** ¬£10,000 stolen from James

#### Scenario 2: Integer Overflow Attack

**Objective:** Cause arithmetic overflow and unpredictable behaviour

**Technical Mechanism:**
1. Input: `9223372036854775807` (MAX_LONG_LONG)
2. Conversion: `std::stoll()` succeeds
3. Multiplication: `MAX_LONG_LONG * 100` ‚Üí **Integer overflow!**
4. Result: Negative number due to wrap-around
5. **Impact:** Bypasses balance checks, corrupts calculations

**Step-by-Step Exploitation:**

1. **Generate maximum overflow payload:**
   - Use: "Integer Overflow - Maximum Long Value"
   - Payload: `9223372036854775807`

2. **Execute attack:**
   - Transfer from any account with the overflow amount
   - Observe application behaviour

**Expected Results:**
- Arithmetic overflow during multiplication
- Negative result from wrap-around
- Unpredictable balance calculations
- Potential system instability

#### Scenario 3: Edge Case Exploitation

**Payload Examples:**

```bash
# Zero bypass (tests edge case handling)
Amount: 0

# Decimal confusion
Amount: 1000.999999999

# Scientific notation (if supported)
Amount: 1e10

# Very large valid number (near overflow threshold)
Amount: 92233720368547758
```

### Integer Overflow Deep Dive

**64-bit Signed Integer Limits:**
- **Maximum:** 9,223,372,036,854,775,807
- **Minimum:** -9,223,372,036,854,775,808
- **Overflow behaviour:** Wraps to negative minimum

**Multiplication Overflow Example:**
```cpp
long long max_val = 9223372036854775807;
long long result = max_val * 100;  // Overflow!
// result is now negative due to wrap-around
```

**Attack Vector Analysis:**
1. **Input validation bypass:** Negative numbers pass initial checks
2. **Business logic flaw:** Assumes only positive amounts
3. **Arithmetic overflow:** Large numbers cause wrap-around
4. **Balance corruption:** Invalid calculations affect account balances

## üõ°Ô∏è Remediation Verification

### Testing the Secure Version

1. **Build secure version:**
   ```bash
   make clean
   make run-secure
   ```

2. **Attempt same exploits:**
   - Buffer overflow payloads ‚Üí **Rejected with validation errors**
   - Negative transfers ‚Üí **Blocked with security logging**
   - Large numbers ‚Üí **Range validation prevents overflow**

3. **Observe security features:**
   ```
   [SECURITY] 2024-09-15 14:30:15 - Input validation failed: full_name exceeds maximum length (32)
   [SECURITY] 2024-09-15 14:30:22 - Transaction validation failed: Amount outside valid range: -10000
   ```

### Security Controls in Secure Version

**Buffer Overflow Protection:**
```cpp
// Bounds checking before copy
if (!validateStringInput(new_name, sizeof(Customer::full_name), "full_name")) {
    return;  // Reject with error
}

// Safe copying with explicit null termination
strncpy(customer.full_name, new_name.c_str(), sizeof(customer.full_name) - 1);
customer.full_name[sizeof(customer.full_name) - 1] = '\0';
```

**Integer Overflow Protection:**
```cpp
// Comprehensive input validation
std::optional<long long> parseTransactionAmount(const std::string& amount_str) {
    // Format validation
    // Range checking
    // Overflow prevention
    // Business logic validation
}
```

## Impact Assessment

### Buffer Overflow Impact
- **Immediate:** Application crash, denial of service
- **Advanced:** Memory corruption, data theft
- **Critical:** Code execution, system compromise

### Integer Overflow Impact
- **Financial:** Unauthorised money transfers
- **Business Logic:** Balance calculation corruption  
- **System:** Arithmetic overflow causing instability

## Detection and Prevention

### Static Analysis Detection
```bash
# Example static analysis commands
clang-tidy --checks='security-*,cert-*' src/vulnerable_bank.cpp
cppcheck --enable=all src/vulnerable_bank.cpp
```

### Runtime Detection
```bash
# Compile with AddressSanitizer for buffer overflow detection
g++ -fsanitize=address -g src/vulnerable_bank.cpp -o vulnerable_bank_debug

# Compile with UBSan for integer overflow detection  
g++ -fsanitize=undefined -g src/vulnerable_bank.cpp -o vulnerable_bank_debug
```

### Manual Code Review Checklist
- [ ] All string operations use bounds-checked functions
- [ ] Numeric conversions include range validation
- [ ] Input validation before processing
- [ ] Error handling for edge cases
- [ ] Security logging for suspicious activities

## Learning Objectives Review

After completing these exploitations, you should understand:

1. **Technical Mechanics:** How buffer overflows and integer overflows work
2. **Exploitation Techniques:** Practical attack methodologies  
3. **Impact Assessment:** Real-world consequences of these vulnerabilities
4. **Remediation Strategies:** Effective countermeasures and secure coding practices

## üìö Further Reading

- **OWASP Buffer Overflow Prevention Cheat Sheet**
- **CERT SEI C++ Secure Coding Standards**
- **CWE-120: Buffer Copy without Checking Size of Input**
- **CWE-190: Integer Overflow or Wraparound**

---

**Remember:** These techniques are powerful and potentially dangerous. Use them responsibly and only in authorised training environments.